name: Refresh Portfolio Data

on:
  # Run every 30 minutes during US market hours (Mon-Fri, 9:30 AM - 4:00 PM ET)
  # GitHub Actions uses UTC, so 9:30 AM ET = 14:30 UTC, 4:00 PM ET = 21:00 UTC
  # Note: This is approximate - we run at :00 and :30 each hour during market window
  schedule:
    - cron: '0,30 14-20 * * 1-5'   # Mon-Fri, 2:30 PM - 8:30 PM UTC (covers 9:30 AM - 4 PM ET)
  
  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  refresh-data:
    runs-on: ubuntu-latest
    
    # Grant write permissions for pushing commits
    permissions:
      contents: write
    
    # Only run if it's actually a trading day (skip holidays, etc. - handled by Alpaca returning same data)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Create .env file from secrets
        run: |
          cat << EOF > .env
          CHATGPT_ALPACA_KEY=${{ secrets.CHATGPT_ALPACA_KEY }}
          CHATGPT_ALPACA_SECRET=${{ secrets.CHATGPT_ALPACA_SECRET }}
          GEMINI_ALPACA_KEY=${{ secrets.GEMINI_ALPACA_KEY }}
          GEMINI_ALPACA_SECRET=${{ secrets.GEMINI_ALPACA_SECRET }}
          CLAUDE_ALPACA_KEY=${{ secrets.CLAUDE_ALPACA_KEY }}
          CLAUDE_ALPACA_SECRET=${{ secrets.CLAUDE_ALPACA_SECRET }}
          PERPLEXITY_ALPACA_KEY=${{ secrets.PERPLEXITY_ALPACA_KEY }}
          PERPLEXITY_ALPACA_SECRET=${{ secrets.PERPLEXITY_ALPACA_SECRET }}
          EXPERIMENT_START_DATE=2026-01-05
          EOF
      
      - name: Run performance logging script
        run: python scripts/log_performance.py
      
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add the data files
          git add logs/performance.csv logs/portfolios.json logs/last_updated.json
          
          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“Š Auto-refresh portfolio data [skip ci]"
            git push
          fi
