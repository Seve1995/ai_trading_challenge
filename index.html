<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO & Social Sharing -->
    <meta name="description"
        content="Watch 4 AI models compete with $1,000 each in the stock market. Live performance tracking of ChatGPT, Gemini, Claude, and Perplexity.">
    <meta name="keywords"
        content="AI investing, ChatGPT trading, Gemini stocks, Claude portfolio, AI vs AI, stock market experiment">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://seve1995.github.io/ai-portfolio-experiment/">
    <meta property="og:title" content="AI Portfolio Experiment - Which AI Wins?">
    <meta property="og:description"
        content="$1,000 to invest. 4 AI models. Who makes the best trades? Watch the live competition.">
    <meta property="og:image" content="https://seve1995.github.io/ai-portfolio-experiment/og-image.png">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://seve1995.github.io/ai-portfolio-experiment/">
    <meta name="twitter:title" content="AI Portfolio Experiment - Which AI Wins?">
    <meta name="twitter:description"
        content="$1,000 to invest. 4 AI models. Who makes the best trades? Watch the live competition.">
    <meta name="twitter:image" content="https://seve1995.github.io/ai-portfolio-experiment/og-image.png">

    <title>AI Portfolio Experiment | Performance Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root {
            /* 2026 Viral Theme - Dark (Default) */
            --bg-color: #05070a;
            --card-bg: rgba(13, 17, 23, 0.7);
            --accent-primary: #00f2ff;
            /* Cyber Cyan */
            --accent-secondary: #7000ff;
            /* Neon Purple */
            --accent-tertiary: #ff00c8;
            /* Hot Pink */
            --text-main: #e6edf3;
            --text-value: #ffffff;
            --text-dim: #9198a1;
            --glass-bg: rgba(13, 17, 23, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --chart-grid: rgba(255, 255, 255, 0.03);
            --shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            --glow: 0 0 15px rgba(0, 242, 255, 0.3);
        }

        [data-theme="light"] {
            --bg-color: #f8fafc;
            --card-bg: rgba(255, 255, 255, 0.7);
            --accent-primary: #0070f3;
            --accent-secondary: #7928ca;
            --text-main: #0f172a;
            --text-value: #0f172a;
            --text-dim: #64748b;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(0, 0, 0, 0.08);
            --chart-grid: rgba(0, 0, 0, 0.02);
            --shadow: 0 20px 50px rgba(0, 0, 0, 0.05);
            --glow: 0 0 15px rgba(0, 112, 243, 0.2);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Outfit', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
            padding: 40px 20px;
            overflow-x: hidden;
            text-rendering: optimizeLegibility;
            position: relative;
            font-size: 16px;
            /* Bumper up generic size */
            letter-spacing: -0.01em;
        }

        /* Dynamic Mesh Gradient Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 0% 0%, rgba(0, 242, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, rgba(112, 0, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(255, 0, 200, 0.03) 0%, transparent 50%);
            background-size: 200% 200%;
            animation: backgroundMovement 20s ease infinite alternate;
            z-index: -2;
            pointer-events: none;
        }

        @keyframes backgroundMovement {
            0% {
                background-position: 0% 0%;
            }

            100% {
                background-position: 100% 100%;
            }
        }

        [data-theme="light"] body::before {
            background:
                radial-gradient(circle at 0% 0%, rgba(0, 112, 243, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, rgba(121, 40, 202, 0.03) 0%, transparent 50%);
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            position: relative;
        }

        header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 50px;
            position: relative;
        }

        /* Modern Theme Toggle Switch */
        .theme-switch {
            position: absolute;
            top: -10px;
            right: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .theme-switch-track {
            width: 56px;
            height: 28px;
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .theme-switch-track:hover {
            border-color: var(--accent-primary);
        }

        .theme-switch-thumb {
            width: 22px;
            height: 22px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 3px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        [data-theme="light"] .theme-switch-thumb {
            transform: translateX(26px);
        }

        .theme-switch-icons {
            display: flex;
            justify-content: space-between;
            padding: 0 6px;
            width: 100%;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            pointer-events: none;
        }

        .theme-switch-icons span {
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }

        [data-theme="dark"] .theme-switch-icons .icon-moon {
            opacity: 1;
        }

        [data-theme="light"] .theme-switch-icons .icon-sun {
            opacity: 1;
        }

        h1 {
            font-size: clamp(2.5rem, 5vw, 4rem);
            font-weight: 700;
            margin-bottom: 15px;
            background: linear-gradient(-45deg, #00f2ff, #7000ff, #ff00c8, #00f2ff);
            background-size: 300%;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientHeading 8s ease infinite;
            letter-spacing: -0.03em;
            line-height: 1.1;
            margin-bottom: 15px;
        }

        /* Monospace for Numbers (The "Pro" Look) */
        .mono-font,
        .value,
        .change,
        .stat-card .value,
        .chart-tooltip-value {
            font-family: 'JetBrains Mono', monospace;
            font-feature-settings: "zero" 1;
            /* Slashed zero */
        }

        @keyframes gradientHeading {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        p.subtitle {
            color: var(--text-dim);
            font-size: 1.1rem;
        }

        .header-links {
            display: inline-flex;
            gap: 16px;
            margin-left: 16px;
        }

        .header-links a {
            color: var(--text-dim);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s ease;
            border-bottom: 1px dashed transparent;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .header-links a:hover {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }

        .header-links svg {
            opacity: 0.7;
            transition: transform 0.2s ease;
        }

        .header-links a:hover svg {
            opacity: 1;
            transform: translateY(-1px);
        }

        /* Intro Section */
        .intro-section {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .intro-card {
            flex: 1;
            min-width: 280px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .intro-card:hover {
            transform: translateY(-10px);
            border-color: var(--accent-primary);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.3);
        }

        .intro-card h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-main);
        }

        .intro-card p {
            color: var(--text-dim);
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .intro-links {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .intro-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 10px;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .intro-link.primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: #fff;
        }

        .intro-link.secondary {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
        }

        .intro-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .glass-isolation-layer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: -1;
            pointer-events: none;
        }

        .stat-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1;
        }

        .stat-card:hover {
            transform: translateY(-10px) scale(1.02);
            border-color: var(--accent-primary);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4);
        }

        .stat-card h3 {
            font-size: 14px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-value);
        }

        .stat-card .change {
            font-size: 0.9rem;
            margin-top: 8px;
        }

        .change.plus {
            color: #1a7f37;
        }

        [data-theme="dark"] .change.plus {
            color: #3fb950;
        }

        .change.minus {
            color: #d1242f;
        }

        [data-theme="dark"] .change.minus {
            color: #f85149;
        }

        .chart-container {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 40px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            z-index: 1;
            margin-bottom: 40px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .chart-wrapper {
            position: relative;
            height: 480px;
            /* Stable height for the chart */
            width: 100%;
            margin-top: 10px;
        }

        #performanceChart {
            width: 100% !important;
            height: 100% !important;
            display: block;
        }

        .footer {
            margin-top: 60px;
            text-align: center;
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        @keyframes fadeInStagger {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stagger-1 {
            animation: fadeInStagger 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            opacity: 0;
        }

        .stagger-2 {
            animation: fadeInStagger 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) 0.1s forwards;
            opacity: 0;
        }

        .stagger-3 {
            animation: fadeInStagger 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) 0.2s forwards;
            opacity: 0;
        }

        .stagger-4 {
            animation: fadeInStagger 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) 0.3s forwards;
            opacity: 0;
        }

        .stagger-4 {
            animation: fadeInStagger 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) 0.3s forwards;
            opacity: 0;
        }

        /* Staggered Cards one-by-one */
        .stats-grid .stat-card {
            opacity: 0;
            animation: fadeInStagger 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .stats-grid .stat-card:nth-child(1) {
            animation-delay: 0.1s;
        }

        .stats-grid .stat-card:nth-child(2) {
            animation-delay: 0.2s;
        }

        .stats-grid .stat-card:nth-child(3) {
            animation-delay: 0.3s;
        }

        .stats-grid .stat-card:nth-child(4) {
            animation-delay: 0.4s;
        }

        /* Removed default fade in to use staggered classes */

        .segmented-control {
            display: flex;
            background: var(--card-bg);
            padding: 4px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            gap: 2px;
        }

        .segment-btn {
            background: transparent;
            border: none;
            color: var(--text-dim);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-family: inherit;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .segment-btn.active {
            background: var(--accent-primary);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* Dark Mode: Tinted style for less contrast */
        [data-theme="dark"] .segment-btn.active {
            background: rgba(0, 242, 255, 0.15);
            color: var(--accent-primary);
            border: 1px solid rgba(0, 242, 255, 0.3);
            box-shadow: 0 0 10px rgba(0, 242, 255, 0.1);
        }

        .segment-btn:not(.active):hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
        }

        .btn-share {
            padding: 8px 16px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: white;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--glow);
            transition: all 0.2s ease;
            font-family: inherit;
            font-weight: 500;
        }

        .btn-share:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* Dark Mode: Glassy gradient for Share button */
        [data-theme="dark"] .btn-share {
            background: linear-gradient(135deg, rgba(0, 242, 255, 0.1), rgba(112, 0, 255, 0.1));
            border: 1px solid var(--glass-border);
            color: var(--accent-primary);
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.05);
        }

        [data-theme="dark"] .btn-share:hover {
            border-color: var(--accent-primary);
            background: linear-gradient(135deg, rgba(0, 242, 255, 0.2), rgba(112, 0, 255, 0.2));
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.2);
        }

        /* Chart Focus Mode */
        .chart-wrapper.focus-mode canvas {
            filter: grayscale(0.5) opacity(0.5);
            transition: filter 0.3s ease;
        }

        .chart-wrapper.focus-mode canvas:hover {
            filter: grayscale(0) opacity(1);
        }

        /* Custom Legend Styling */
        .custom-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-main);
            transition: opacity 0.2s ease;
        }

        .legend-item:hover {
            opacity: 0.7;
        }

        .legend-item.hidden {
            text-decoration: line-through;
            opacity: 0.3;
            filter: grayscale(100%);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* Table zebra striping and hover */
        #historyBody tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        [data-theme="light"] #historyBody tr:nth-child(even) {
            background: rgba(0, 0, 0, 0.02);
        }

        #historyBody tr:hover {
            background: rgba(88, 166, 255, 0.1);
        }

        [data-theme="light"] #historyBody tr:hover {
            background: rgba(9, 105, 218, 0.08);
        }

        .test-banner {
            background: #d29922;
            color: #0b0e14;
            text-align: center;
            padding: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        /* Portfolio Holdings Section */
        .portfolio-section {
            margin-top: 40px;
        }

        .portfolio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .portfolio-header h2 {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .date-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-selector select {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            padding: 8px 12px;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .holdings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .holdings-card {
            background: linear-gradient(135deg, var(--card-bg) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow), 0 0 0 1px rgba(255, 255, 255, 0.05);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .holdings-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #10b981, #f59e0b, #ec4899);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .holdings-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow), 0 20px 40px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(59, 130, 246, 0.3);
        }

        .holdings-card:hover::before {
            opacity: 1;
        }

        .holdings-card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .holdings-card-header .model-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .holdings-card-header h3 {
            font-size: 1rem;
            font-weight: 600;
            margin: 0;
        }

        .holdings-card-body {
            padding: 16px 20px;
            min-height: 100px;
        }

        .holding-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--glass-border);
        }

        .holding-row:last-child {
            border-bottom: none;
        }

        .holding-ticker {
            font-weight: 600;
            color: var(--text-value);
        }

        .holding-details {
            text-align: right;
            font-size: 0.85rem;
        }

        .holding-qty {
            color: var(--text-dim);
        }

        .holding-pl {
            font-weight: 500;
        }

        .holding-pl.positive {
            color: #3fb950;
        }

        .holding-pl.negative {
            color: #f85149;
        }

        /* Activity Feed */
        .activity-feed-section {
            margin-bottom: 30px;
        }

        .activity-feed {
            max-height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-right: 8px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 12px 16px;
            border: 1px solid var(--glass-border);
            transition: transform 0.2s, background 0.2s;
        }

        .activity-item:hover {
            transform: translateX(4px);
            background: rgba(255, 255, 255, 0.05);
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .activity-icon.buy {
            background: rgba(63, 185, 80, 0.15);
            color: #3fb950;
        }

        .activity-icon.sell {
            background: rgba(248, 81, 73, 0.15);
            color: #f85149;
        }

        .activity-content {
            flex-grow: 1;
            font-size: 0.9rem;
            color: var(--text-main);
        }

        .activity-time {
            font-size: 0.75rem;
            color: var(--text-dim);
            min-width: 80px;
            text-align: right;
        }

        /* Allocation Bar */
        .allocation-bar-container {
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            overflow: hidden;
            height: 8px;
            display: flex;
        }

        .alloc-segment {
            height: 100%;
            transition: width 0.5s ease;
        }

        .alloc-stocks {
            background: var(--accent-success);
        }

        .alloc-cash {
            background: var(--text-dim);
            opacity: 0.3;
        }

        .allocation-stats {
            display: flex;
            gap: 15px;
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-bottom: 12px;
            margin-top: -15px;
        }

        /* Sector Badge - refined */
        .sector-badge {
            display: inline-block;
            font-size: 0.6rem;
            padding: 1px 5px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: var(--text-dim);
            margin-left: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            vertical-align: middle;
        }

        .holdings-card-body {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Modern 2-Column Grid for Holdings */
        .holding-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .h-col-ticker {
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .h-col-stats {
            text-align: right;
        }

        .holding-ticker {
            font-weight: 700;
            color: var(--text-main);
            font-size: 1rem;
        }

        /* Sector Dot with Tooltip */
        .sector-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #6b7280;
            cursor: help;
        }

        .sector-dot.healthcare {
            background-color: #10b981;
        }

        .sector-dot.technology {
            background-color: #3b82f6;
        }

        .sector-dot.energy {
            background-color: #f59e0b;
        }

        .sector-dot.consumer {
            background-color: #ec4899;
        }

        .sector-dot.financial {
            background-color: #8b5cf6;
        }

        .sector-dot.industrial {
            background-color: #6366f1;
        }

        .stats-primary {
            display: flex;
            justify-content: flex-end;
            align-items: baseline;
            gap: 12px;
            font-size: 0.95rem;
        }

        .stats-value {
            font-weight: 600;
            color: var(--text-main);
        }

        .stats-pnl {
            font-weight: 600;
        }

        .stats-secondary {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-top: 2px;
        }

        .holding-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        /* Allocation Visualization - Enhanced */
        .allocation-display {
            margin-bottom: 16px;
        }

        .allocation-bar-wrapper {
            margin-bottom: 6px;
        }

        .allocation-bar-track {
            width: 100%;
            height: 14px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid rgba(128, 128, 128, 0.2);
            border-radius: 7px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            cursor: help;
            transition: box-shadow 0.3s ease;
        }

        .allocation-bar-track:hover {
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1), 0 0 8px rgba(59, 130, 246, 0.3);
        }

        /* Bar segments for sector-colored allocation */
        .bar-segment {
            height: 100%;
            display: inline-block;
            transition: all 0.3s ease;
            position: relative;
        }

        .bar-segment:hover {
            transform: scaleY(1.3);
            filter: brightness(1.2);
            z-index: 10;
        }

        .bar-segment:first-child {
            border-radius: 6px 0 0 6px;
        }

        .bar-segment:last-child {
            border-radius: 0 6px 6px 0;
        }

        .bar-segment:only-child {
            border-radius: 6px;
        }

        /* Cash segment with inline label */
        .bar-segment.bar-cash {
            background-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cash-label {
            font-size: 0.6rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .allocation-summary {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-align: center;
            margin-top: 6px;
        }

        .allocation-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.65rem;
            color: var(--text-dim);
            margin-top: 4px;
        }

        .alloc-label-invested {
            font-weight: 600;
        }

        .allocation-values {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .allocation-values strong {
            color: var(--text-main);
        }

        .empty-holdings {
            color: var(--text-dim);
            font-style: italic;
            text-align: center;
            padding: 20px 0;
        }

        /* Leaderboard Rankings */
        .rank-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            color: white;
        }

        .rank-badge.rank-1 {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
        }

        .rank-badge.rank-2 {
            background: linear-gradient(135deg, #c0c0c0, #a8a8a8);
        }

        .rank-badge.rank-3 {
            background: linear-gradient(135deg, #cd7f32, #b8722d);
        }

        .rank-badge.rank-4 {
            background: var(--text-dim);
            opacity: 0.7;
        }

        .stat-card.leader {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3), var(--shadow);
        }

        .leader-label {
            font-size: 0.75rem;
            color: #b8860b;
            /* Darker gold for better contrast in light mode */
            margin-top: 8px;
            font-weight: 600;
        }

        [data-theme="dark"] .leader-label {
            color: #ffd700;
            /* Bright gold for dark mode */
        }

        /* Twitter Share Button */
        .share-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: rgba(29, 161, 242, 0.1);
            color: #1da1f2;
            border: 1px solid rgba(29, 161, 242, 0.3);
            border-radius: 20px;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            margin-top: 15px;
        }

        .share-btn:hover {
            background: rgba(29, 161, 242, 0.2);
            transform: translateY(-2px);
        }

        /* Countdown Styled for Footer */
        .countdown-footer {
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: var(--text-dim);
            font-weight: 500;
        }

        .countdown-value {
            color: var(--text-color);
            font-weight: 600;
        }

        /* Animated counter styles */
        .value[data-target] {
            font-variant-numeric: tabular-nums;
        }

        /* Header actions row */
        .header-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Sparkline container */
        .sparkline {
            height: 30px;
            margin-top: 10px;
        }

        .sparkline canvas {
            width: 100% !important;
            height: 30px !important;
        }

        /* Pulsing market status indicator */
        .market-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
            vertical-align: middle;
        }

        .market-indicator.open {
            background: #3fb950;
            box-shadow: 0 0 0 0 rgba(63, 185, 80, 0.7);
            animation: pulse-green 2s infinite;
        }

        .market-indicator.closed {
            background: #f85149;
            box-shadow: 0 0 0 0 rgba(248, 81, 73, 0.7);
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0 0 rgba(63, 185, 80, 0.7);
            }

            70% {
                box-shadow: 0 0 0 8px rgba(63, 185, 80, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(63, 185, 80, 0);
            }
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(248, 81, 73, 0.7);
            }

            70% {
                box-shadow: 0 0 0 8px rgba(248, 81, 73, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(248, 81, 73, 0);
            }
        }

        /* Media Queries for Responsiveness */
        @media (max-width: 768px) {
            body {
                padding: 20px 10px;
            }

            header {
                margin-bottom: 30px;
            }

            .chart-container {
                padding: 20px 15px;
            }

            .chart-header {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 20px !important;
            }

            .chart-controls {
                width: 100% !important;
                justify-content: space-between !important;
            }

            .chart-wrapper {
                height: 350px;
            }

            .custom-legend {
                gap: 10px;
                margin-bottom: 15px;
            }

            .legend-item {
                font-size: 11px !important;
            }

            h1 {
                font-size: 2.2rem;
            }

            .subtitle {
                font-size: 0.95rem;
                text-align: center;
            }

            .header-links {
                margin-left: 0;
                margin-top: 10px;
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .chart-wrapper {
                height: 300px;
            }

            .stat-card {
                padding: 20px;
            }

            .stat-card .value {
                font-size: 1.5rem;
            }
        }

        /* Donut Charts Grid */
        .donuts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 30px;
            justify-items: center;
        }

        .donut-wrapper {
            text-align: center;
            width: 100%;
            max-width: 250px;
        }

        .donut-wrapper h5 {
            font-size: 1rem;
            margin-bottom: 15px;
            color: var(--text-main);
            font-weight: 600;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1;
        }

        /* Ticker Styles (Inline Badge) */
        .experiment-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(128, 128, 128, 0.1);
            border: 1px solid var(--glass-border);
            padding: 6px 16px;
            border-radius: 99px;
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-top: 16px;
            margin-bottom: 8px;
            backdrop-filter: blur(4px);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            background-color: #f85149;
            border-radius: 50%;
            box-shadow: 0 0 8px #f85149;
            animation: pulse-red 1.5s infinite;
        }

        .ticker-highlight {
            color: var(--text-main);
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            margin-left: 4px;
        }
    </style>
</head>

<body>
    <!-- Top Ticker -->
    <!-- Top Ticker Removed -->
    <div class="test-banner" id="testBanner" style="display: none;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: middle;">
            <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" />
            <path d="M12 9v4" />
            <path d="M12 17h.01" />
        </svg>
        TEST MODE: Displaying Simulated Performance Data
    </div>
    <div class="container">
        <header class="stagger-1">
            <div class="theme-switch" id="themeToggle">
                <div class="theme-switch-track">
                    <div class="theme-switch-icons">
                        <span class="icon-moon">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />
                            </svg>
                        </span>
                        <span class="icon-sun">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="4" />
                                <path d="M12 2v2" />
                                <path d="M12 20v2" />
                                <path d="m4.93 4.93 1.41 1.41" />
                                <path d="m17.66 17.66 1.41 1.41" />
                                <path d="M2 12h2" />
                                <path d="M20 12h2" />
                                <path d="m6.34 17.66-1.41 1.41" />
                                <path d="m19.07 4.93-1.41 1.41" />
                            </svg>
                        </span>
                    </div>
                    <div class="theme-switch-thumb"></div>
                </div>
            </div>
            <!-- Removed default pill, moved to ticker -->
            <h1>AI Portfolio Experiment</h1>
            <p class="subtitle">
                Comparing four $1,000 investment portfolios managed by AI.
                <span class="header-links">
                    <a href="https://aiportfolioexperiment.substack.com/" target="_blank" rel="noopener">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path
                                d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2" />
                            <path d="M18 14h-8" />
                            <path d="M15 18h-5" />
                            <path d="M10 6h8v4h-8V6Z" />
                        </svg>
                        Substack Blog
                    </a>
                    <a href="https://github.com/seve1995/ai-portfolio-experiment" target="_blank" rel="noopener">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="16 18 22 12 16 6" />
                            <polyline points="8 6 2 12 8 18" />
                            <line x1="12" x2="12" y1="2" y2="22" />
                        </svg>
                        Source Code
                    </a>
                </span>
            </p>

            <!-- Inline Status Badge -->
            <div id="countdownBanner" class="experiment-status-badge">
                <span class="status-dot"></span>
                <span>LIVE EXPERIMENT</span>
                <span style="opacity: 0.3; margin: 0 4px;">|</span>
                <span>Ends in</span>
                <span class="ticker-highlight" id="countdownValue">-- days</span>
            </div>
        </header>



        <div class="stats-grid" id="statsGrid">
            <!-- Stats will be injected here -->
            <div class="stat-card">
                <div class="glass-isolation-layer"></div>
                <h3>ChatGPT</h3>
                <div class="value">$----.--</div>
                <div class="change">--%</div>
            </div>
            <div class="stat-card">
                <h3>Gemini</h3>
                <div class="value">$----.--</div>
                <div class="change">--%</div>
            </div>
            <div class="stat-card">
                <h3>Claude</h3>
                <div class="value">$----.--</div>
                <div class="change">--%</div>
            </div>
            <div class="stat-card">
                <h3>Perplexity</h3>
                <div class="value">$----.--</div>
                <div class="change">--%</div>
            </div>
        </div>

        <div class="chart-container stagger-3">
            <div class="chart-header">
                <div>
                    <h2>Equity Growth Over Time</h2>
                    <p id="lastSync" style="font-size: 0.8rem; color: var(--text-dim); margin-top: 4px;">Syncing data...
                    </p>
                    <p id="dateRange" style="font-size: 0.75rem; color: var(--text-dim); margin-top: 2px;"></p>
                </div>
                <div class="chart-controls" style="display: flex; gap: 15px; align-items: center;">
                    <div class="segmented-control">
                        <button class="segment-btn active" data-scale="dynamic"
                            onclick="setYScale('dynamic')">Dynamic</button>
                        <button class="segment-btn" data-scale="zero" onclick="setYScale('zero')">From $0</button>
                    </div>
                    <button id="downloadBtn" onclick="takeSnapshot()" class="custom-file-upload btn-share">
                        <span id="snapshotBtnIcon">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8" />
                                <polyline points="16 6 12 2 8 6" />
                                <line x1="12" x2="12" y1="2" y2="15" />
                            </svg>
                        </span>
                        <span id="snapshotBtnText">Share Chart</span>
                    </button>
                </div>
            </div>
            <div id="chartLegend" class="custom-legend"></div>
            <div class="chart-wrapper">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>

        <!-- Activity Feed -->
        <div class="activity-feed-section stagger-4">
            <h2>Recent Activity</h2>
            <div id="activityFeed" class="activity-feed">
                <!-- Activity items will be populated by JS -->
                <div style="padding: 20px; text-align: center; color: var(--text-dim);">Loading activity...</div>
            </div>
        </div>

        <div class="portfolio-section stagger-4">
            <div class="portfolio-header">
                <h2>Portfolio Holdings</h2>
                <div class="date-selector">
                    <span style="color: var(--text-dim); font-size: 0.9rem;">View date:</span>
                    <select id="holdingsDateSelect">
                        <option value="">Loading...</option>
                    </select>
                </div>
            </div>
            <div class="holdings-grid" id="holdingsGrid">
                <!-- Holdings cards will be injected here -->
            </div>
        </div>

        <!-- Donut Charts Removed -->

        <footer class="footer">
            <p style="margin-bottom: 8px;"><strong>Disclaimer:</strong> This is a research experiment for educational
                purposes only. It is not financial advice. Past performance is not indicative of future results.</p>
            <p>&copy; 2026 AI Portfolio Experiment. Built for Deep Research AI Analysis.</p>
            <button class="share-btn" onclick="shareOnTwitter()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
                </svg>
                Share This Experiment on X
            </button>
        </footer>
    </div>

    <script>
        const ctx = document.getElementById('performanceChart').getContext('2d');
        let chart;

        const colors = {
            'ChatGPT': '#58a6ff',
            'Gemini': '#bc8cff',
            'Claude': '#3fb950',
            'Perplexity': '#f85149'
        };

        const modelVersions = {
            'ChatGPT': 'ChatGPT 5.2',
            'Gemini': 'Gemini 3 Pro',
            'Claude': 'Claude 4.5 Opus',
            'Perplexity': 'Perplexity Pro'
        };

        const initialCapital = 1000;
        let yAxisStartAtZero = false;

        // Theme Handling
        const themeToggle = document.getElementById('themeToggle');

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);

            if (chart) {
                updateChartTheme();
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            setTheme(currentTheme === 'dark' ? 'light' : 'dark');
        }

        themeToggle.addEventListener('click', toggleTheme);

        // Scale Handling
        function setYScale(mode) {
            yAxisStartAtZero = (mode === 'zero');

            // Update UI
            document.querySelectorAll('.segment-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.scale === mode);
            });

            if (chart) {
                chart.options.scales.y.beginAtZero = yAxisStartAtZero;
                chart.options.scales.y.grace = yAxisStartAtZero ? '0%' : '10%';
                chart.update();
            }
        }

        // Initialize theme
        const savedTheme = localStorage.getItem('theme') || 'dark';
        setTheme(savedTheme);

        // Dynamic button text based on device
        function updateSnapshotButton() {
            const textEl = document.getElementById('snapshotBtnText');
            const iconEl = document.getElementById('snapshotBtnIcon');

            // Check if truly on mobile device (user agent) AND supports Web Share with files
            const isMobileDevice = /Android|iPhone|iPad|iPod|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const canShareFiles = navigator.canShare && navigator.canShare({
                files: [new File([''], 'test.png', { type: 'image/png' })]
            });

            if (isMobileDevice && canShareFiles) {
                textEl.textContent = 'Share Chart';
                iconEl.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8" />
                    <polyline points="16 6 12 2 8 6" />
                    <line x1="12" x2="12" y1="2" y2="15" />
                </svg>`;
            } else {
                textEl.textContent = 'Download Chart';
                iconEl.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                    <polyline points="7 10 12 15 17 10" />
                    <line x1="12" x2="12" y1="15" y2="3" />
                </svg>`;
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Update button text based on device capabilities
            updateSnapshotButton();

            const timestamp = new Date().getTime();
            const csvPath = `logs/performance.csv?t=${timestamp}`;
            const lastUpdatedPath = `logs/last_updated.json?t=${timestamp}`;

            // Fetch last updated timestamp
            fetch(lastUpdatedPath)
                .then(response => response.ok ? response.json() : null)
                .then(data => {
                    if (data && data.timestamp) {
                        updateLastSyncDisplay(data.timestamp);
                    }
                })
                .catch(() => console.log('No last_updated.json found'));

            fetch(csvPath)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.text();
                })
                .then(text => {
                    if (typeof Papa === 'undefined') throw new Error('PapaParse library not loaded');
                    Papa.parse(text, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true,
                        complete: function (results) {
                            if (results.data.length === 0) {
                                console.warn('CSV is empty');
                                return;
                            }
                            processData(results.data);
                        },
                        error: function (err) {
                            throw new Error(`Parse error: ${err.message}`);
                        }
                    });
                })
                .catch(err => {
                    console.error('Auto-fetch failed:', err);
                    const syncEl = document.getElementById('lastSync');
                    if (syncEl) syncEl.textContent = `Data Error: ${err.message}`;
                });
        });

        function updateLastSyncDisplay(isoTimestamp) {
            const syncTime = new Date(isoTimestamp);
            const now = new Date();
            const diffMs = now - syncTime;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);

            let timeAgo;
            if (diffMins < 1) {
                timeAgo = 'just now';
            } else if (diffMins < 60) {
                timeAgo = `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
            } else if (diffHours < 24) {
                timeAgo = `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
            } else {
                timeAgo = syncTime.toLocaleDateString();
            }

            // Check if market is currently open (Mon-Fri, 9:30 AM - 4:00 PM ET)
            const marketStatus = getMarketStatus();
            const indicatorClass = marketStatus.isOpen ? 'open' : 'closed';
            const statusText = marketStatus.isOpen ? 'Market Open' : 'Market Closed';

            document.getElementById('lastSync').innerHTML =
                `<span class="market-indicator ${indicatorClass}"></span>${statusText}  Last updated: ${timeAgo}`;
        }

        function getMarketStatus() {
            const now = new Date();
            const etOffset = -5; // EST (adjust for DST if needed)
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const etTime = new Date(utc + (3600000 * etOffset));

            const day = etTime.getDay();
            const hours = etTime.getHours();
            const minutes = etTime.getMinutes();
            const timeInMinutes = hours * 60 + minutes;

            // Market hours: Mon-Fri, 9:30 AM - 4:00 PM ET
            const marketOpen = 9 * 60 + 30;  // 9:30 AM
            const marketClose = 16 * 60;      // 4:00 PM

            const isWeekday = day >= 1 && day <= 5;
            const isDuringHours = timeInMinutes >= marketOpen && timeInMinutes < marketClose;

            return {
                isOpen: isWeekday && isDuringHours
            };
        }

        function processData(data) {
            const cleanData = data.filter(row => row.Date);
            if (cleanData.length === 0) return;

            const firstDate = cleanData[0].Date;
            const latestRow = cleanData[cleanData.length - 1];
            const dateRange = cleanData.length > 1 ? `${firstDate} to ${latestRow.Date}` : latestRow.Date;
            document.getElementById('dateRange').textContent = `Reporting Period: ${dateRange}`;

            const labels = cleanData.map(row => row.Date);
            const models = ['ChatGPT', 'Gemini', 'Claude', 'Perplexity'];

            const datasets = models.map(model => {
                // Create a beautiful gradient for the area fill
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, colors[model] + '44'); // Subtle 25% opacity
                gradient.addColorStop(1, colors[model] + '00'); // Fades to transparent

                return {
                    label: model,
                    data: cleanData.map(row => row[model]),
                    borderColor: colors[model],
                    backgroundColor: gradient,
                    fill: true,
                    cubicInterpolationMode: 'monotone',
                    tension: 0.4,
                    pointRadius: 0, // Hidden by default
                    pointHoverRadius: 6,
                    pointHitRadius: 20,
                    pointHoverBackgroundColor: colors[model],
                    pointHoverBorderColor: '#ffffff',
                    pointHoverBorderWidth: 2,
                    borderWidth: 3
                };
            });

            renderChart(labels, datasets);
            updateStats(latestRow);
        }



        function getThemeColors() {
            const isLight = document.documentElement.getAttribute('data-theme') === 'light';
            return {
                text: isLight ? '#64748b' : '#9198a1',
                grid: isLight ? 'rgba(0, 0, 0, 0.02)' : 'rgba(255, 255, 255, 0.03)',
                tooltipBg: isLight ? 'rgba(255, 255, 255, 0.95)' : 'rgba(13, 17, 23, 0.95)',
                tooltipBorder: isLight ? 'rgba(0, 0, 0, 0.08)' : 'rgba(255, 255, 255, 0.08)',
                tooltipText: isLight ? '#0f172a' : '#e6edf3',
                chartBg: 'transparent'
            };
        }

        function updateChartTheme() {
            const theme = getThemeColors();
            chart.options.scales.y.grid.color = theme.grid;
            chart.options.scales.y.ticks.color = theme.text;
            chart.options.scales.x.ticks.color = theme.text;
            chart.options.plugins.legend.labels.color = theme.tooltipText;
            chart.options.plugins.tooltip.backgroundColor = theme.tooltipBg;
            chart.options.plugins.tooltip.titleColor = theme.tooltipText;
            chart.options.plugins.tooltip.bodyColor = theme.tooltipText;
            chart.options.plugins.tooltip.borderColor = theme.tooltipBorder;
            // Update canvas background
            chart.config.options.plugins.customCanvasBackground.color = theme.chartBg;
            chart.update();
        }

        function renderChart(labels, datasets) {
            if (chart) chart.destroy();
            const theme = getThemeColors();

            // High-Resolution Sampling for Ultra-Crisp Rendering
            const dpr = window.devicePixelRatio || 2;
            Chart.defaults.devicePixelRatio = Math.min(dpr * 1.5, 4); // Boost resolution for canvas internal elements

            // Plugin for Vertical Crosshair & Interactive Effects
            const crosshairPlugin = {
                id: 'crosshair',
                afterDraw: (chart) => {
                    if (chart.tooltip?._active?.length) {
                        const { ctx } = chart;
                        const { x } = chart.tooltip._active[0].element;
                        const topY = chart.scales.y.top;
                        const bottomY = chart.scales.y.bottom;

                        ctx.save();
                        ctx.beginPath();
                        ctx.moveTo(x, topY);
                        ctx.lineTo(x, bottomY);
                        ctx.lineWidth = 1;
                        ctx.strokeStyle = document.documentElement.getAttribute('data-theme') === 'light'
                            ? 'rgba(0, 0, 0, 0.15)'
                            : 'rgba(255, 255, 255, 0.15)';
                        ctx.setLineDash([6, 4]);
                        ctx.stroke();
                        ctx.restore();
                    }
                }
            };

            // Plugin for Line Glow and Shadow (Enhanced 2026 Look)
            const glowPlugin = {
                id: 'glow',
                beforeDatasetDraw: (chart, args) => {
                    const { ctx } = chart;
                    ctx.save();
                    ctx.shadowBlur = 20;
                    ctx.shadowColor = args.meta.dataset.options.borderColor;
                    ctx.shadowOffsetX = 0;
                    ctx.shadowOffsetY = 0;
                },
                afterDatasetDraw: (chart) => {
                    chart.ctx.restore();
                }
            };

            // Custom Background Plugin (existing)
            const customCanvasBackgroundPlugin = {
                id: 'customCanvasBackground',
                beforeDraw: (chart, args, options) => {
                    const { ctx } = chart;
                    ctx.save();
                    ctx.globalCompositeOperation = 'destination-over';
                    ctx.fillStyle = options.color || '#161b22';
                    ctx.fillRect(0, 0, chart.width, chart.height);
                    ctx.restore();
                }
            };

            chart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                plugins: [customCanvasBackgroundPlugin, crosshairPlugin, glowPlugin],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    devicePixelRatio: Math.min(window.devicePixelRatio * 2, 4), // Super-sampling
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    },
                    layout: {
                        padding: {
                            top: 20,
                            bottom: 10,
                            left: 10,
                            right: 25
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: yAxisStartAtZero,
                            grace: yAxisStartAtZero ? '0%' : '12%',
                            grid: {
                                color: theme.grid,
                                drawBorder: false
                            },
                            ticks: {
                                color: theme.text,
                                padding: 12,
                                padding: 12,
                                font: {
                                    family: 'JetBrains Mono, monospace',
                                    size: 11,
                                    weight: '500'
                                },
                                callback: value => '$' + value.toLocaleString()
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: theme.text,
                                padding: 10,
                                font: {
                                    family: 'JetBrains Mono, monospace',
                                    size: 11,
                                    weight: '500'
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: false, // Use external tooltips
                            external: externalTooltipHandler
                        },
                        customCanvasBackground: {
                            color: theme.chartBg
                        }
                    }
                }
            });

            generateCustomLegend(chart);
        }

        // External Tooltip Handler (The "2026 Modern" Way)
        function externalTooltipHandler(context) {
            // Tooltip Element
            let tooltipEl = document.getElementById('chartjs-tooltip');

            // Create element on first render
            if (!tooltipEl) {
                tooltipEl = document.createElement('div');
                tooltipEl.id = 'chartjs-tooltip';
                tooltipEl.style.background = 'var(--glass-bg)';
                tooltipEl.style.backdropFilter = 'blur(20px)';
                tooltipEl.style.borderRadius = '16px';
                tooltipEl.style.border = '1px solid var(--glass-border)';
                tooltipEl.style.color = 'var(--text-main)';
                tooltipEl.style.opacity = 1;
                tooltipEl.style.pointerEvents = 'none';
                tooltipEl.style.position = 'absolute';
                tooltipEl.style.transition = 'all .1s ease';
                tooltipEl.style.zIndex = 100;
                tooltipEl.style.padding = '12px 16px';
                tooltipEl.style.boxShadow = 'var(--shadow)';
                document.body.appendChild(tooltipEl);
            }

            // Hide if no tooltip
            const tooltipModel = context.tooltip;
            if (tooltipModel.opacity === 0) {
                tooltipEl.style.opacity = 0;
                return;
            }

            // Set Text
            if (tooltipModel.body) {
                const titleLines = tooltipModel.title || [];
                const bodyLines = tooltipModel.body.map(item => item.lines);

                let innerHtml = '<div style="font-weight: 700; margin-bottom: 8px; font-size: 0.9rem;">' + titleLines[0] + '</div>';
                innerHtml += '<div style="display: flex; flex-direction: column; gap: 4px;">';

                bodyLines.forEach((body, i) => {
                    const colors = tooltipModel.labelColors[i];
                    const span = `<span style="display:inline-block; width:10px; height:10px; border-radius:50%; background:${colors.borderColor}; margin-right:8px;"></span>`;
                    innerHtml += `<div style="display: flex; align-items: center; font-size: 0.85rem;">${span}${body}</div>`;
                });
                innerHtml += '</div>';

                tooltipEl.innerHTML = innerHtml;
            }

            const canvas = context.chart.canvas;
            const rect = canvas.getBoundingClientRect();

            // Display, position, and set styles for font
            tooltipEl.style.opacity = 1;
            tooltipEl.style.left = rect.left + window.scrollX + tooltipModel.caretX + 'px';
            tooltipEl.style.top = rect.top + window.scrollY + tooltipModel.caretY + 'px';
            tooltipEl.style.fontFamily = 'Outfit, sans-serif';
        }

        function generateCustomLegend(chartInstance) {
            const legendContainer = document.getElementById('chartLegend');
            legendContainer.innerHTML = '';

            chartInstance.data.datasets.forEach((dataset, i) => {
                const item = document.createElement('div');
                item.className = 'legend-item';

                // Focusing Interaction
                item.onmouseenter = () => {
                    document.querySelector('.chart-wrapper').classList.add('focus-mode');
                    chartInstance.data.datasets.forEach((ds, idx) => {
                        if (idx !== i) {
                            ds.borderColor = colors[ds.label] + '22';
                            ds.backgroundColor = 'transparent';
                        }
                    });
                    chartInstance.update('none');
                };

                item.onmouseleave = () => {
                    document.querySelector('.chart-wrapper').classList.remove('focus-mode');
                    chartInstance.data.datasets.forEach((ds, idx) => {
                        ds.borderColor = colors[ds.label];
                        // Re-create gradient
                        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                        gradient.addColorStop(0, colors[ds.label] + '44');
                        gradient.addColorStop(1, colors[ds.label] + '00');
                        ds.backgroundColor = gradient;
                    });
                    chartInstance.update('none');
                };

                item.onclick = () => {
                    const isVisible = chartInstance.isDatasetVisible(i);
                    chartInstance.setDatasetVisibility(i, !isVisible);
                    chartInstance.update();
                    item.classList.toggle('hidden', isVisible);
                };

                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = dataset.borderColor;

                const text = document.createElement('span');
                text.textContent = modelVersions[dataset.label] || dataset.label;

                item.appendChild(colorBox);
                item.appendChild(text);
                legendContainer.appendChild(item);
            });
        }

        function updateStats(lastRow) {
            const grid = document.getElementById('statsGrid');
            const models = ['ChatGPT', 'Gemini', 'Claude', 'Perplexity'];

            // Calculate rankings
            const rankings = models.map(model => ({
                model,
                value: lastRow[model] || 0
            })).sort((a, b) => b.value - a.value);

            const rankMap = {};
            rankings.forEach((item, index) => {
                rankMap[item.model] = index + 1;
            });

            grid.innerHTML = '';
            models.forEach(model => {
                const val = lastRow[model] || 0;
                const change = ((val - initialCapital) / initialCapital * 100).toFixed(2);
                const isPositive = change >= 0;
                const rank = rankMap[model];
                const isLeader = rank === 1;

                const card = document.createElement('div');
                card.className = `stat-card ${isLeader ? 'leader' : ''}`;
                card.style.animationDelay = `${models.indexOf(model) * 0.1}s`;

                card.innerHTML = `
                    <div class="rank-badge rank-${rank}">${rank === 1 ? '<svg width="15" height="15" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg"><path d="M5 16L3 5L8.5 10L12 4L15.5 10L21 5L19 16H5ZM19 19C19 19.5523 18.5523 20 18 20H6C5.44772 20 5 19.5523 5 19V18H19V19Z"/></svg>' : rank}</div>
                    <div class="model-name" style="color: ${colors[model]}; font-weight: 700; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">
                        ${modelVersions[model]}
                    </div>
                    <div class="value" data-target="${val}">$${initialCapital.toLocaleString()}</div>
                    <div class="change ${isPositive ? 'plus' : 'minus'}">
                        ${isPositive ? '' : ''} ${Math.abs(change)}%
                    </div>

                `;
                grid.appendChild(card);
            });

            // Store rankings globally for share functionality
            window.allRankings = rankings.map(item => {
                const change = ((item.value - initialCapital) / initialCapital * 100).toFixed(2);
                return { name: item.model, change: change };
            });

            // Trigger Counter Animation
            animateCounters();
        }

        function animateCounters() {
            const counters = document.querySelectorAll('.value[data-target]');
            counters.forEach(counter => {
                const target = parseFloat(counter.getAttribute('data-target'));
                const duration = 2000; // 2 seconds
                const startTime = performance.now();
                const startValue = initialCapital;

                function updateCounter(currentTime) {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);

                    // Easing function: easeOutExpo
                    const easeProgress = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);

                    const currentValue = startValue + (target - startValue) * easeProgress;
                    counter.textContent = `$${currentValue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                    if (progress < 1) {
                        requestAnimationFrame(updateCounter);
                    }
                }
                requestAnimationFrame(updateCounter);
            });
        }

        // Snapshot Function (The "Viral" Image Exporter)
        function takeSnapshot() {
            if (!chart) return;

            // 1. Create a hidden high-res canvas for the chart itself
            // We use a fixed 2000x1200 size for the chart component to ensure sharpness
            const exportChartCanvas = document.createElement('canvas');
            exportChartCanvas.width = 2000;
            exportChartCanvas.height = 1200;
            const ecCtx = exportChartCanvas.getContext('2d');

            // 2. Create the final composite canvas (1200x800 for social media optimization)
            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = 1200;
            finalCanvas.height = 800;
            const fCtx = finalCanvas.getContext('2d');

            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const bgColor = isDark ? '#05070a' : '#f8fafc';
            const textColor = isDark ? '#ffffff' : '#0f172a';
            const dimColor = isDark ? '#9198a1' : '#64748b';

            // 3. Render a "Snapshot Version" of the chart to the offscreen canvas
            // We clone the data and options to maintain visual parity but at a fixed high res
            const snapshotChart = new Chart(ecCtx, {
                type: 'line',
                data: JSON.parse(JSON.stringify(chart.data)), // Deep clone data
                options: {
                    ...chart.options,
                    responsive: false,
                    maintainAspectRatio: false,
                    animation: false,
                    devicePixelRatio: 2, // High DPI
                    plugins: {
                        ...chart.options.plugins,
                        legend: { display: false },
                        tooltip: { enabled: false },
                        customCanvasBackground: { color: bgColor }
                    },
                    scales: {
                        y: {
                            ...chart.options.scales.y,
                            ticks: {
                                ...chart.options.scales.y.ticks,
                                font: { size: 14, family: 'JetBrains Mono, monospace', weight: '500' },
                                color: dimColor
                            },
                            grid: { color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' }
                        },
                        x: {
                            ...chart.options.scales.x,
                            ticks: {
                                ...chart.options.scales.x.ticks,
                                font: { size: 14, family: 'JetBrains Mono, monospace', weight: '500' },
                                color: dimColor
                            }
                        }
                    }
                },
                plugins: [
                    {
                        id: 'customBg',
                        beforeDraw: (c) => {
                            const ctx = c.ctx;
                            ctx.save();
                            ctx.fillStyle = bgColor;
                            ctx.fillRect(0, 0, c.width, c.height);
                            ctx.restore();
                        }
                    }
                ]
            });

            // Wait for chart to be ready (even without animation, Chart.js might need a tick)
            setTimeout(() => {
                // 4. Draw Background on Final Canvas
                fCtx.fillStyle = bgColor;
                fCtx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);

                // Add subtle mesh gradient/glows
                fCtx.globalAlpha = 0.15;
                const grad = fCtx.createRadialGradient(0, 0, 0, 0, 0, 1000);
                grad.addColorStop(0, '#00f2ff');
                grad.addColorStop(1, 'transparent');
                fCtx.fillStyle = grad;
                fCtx.beginPath();
                fCtx.arc(0, 0, 1000, 0, Math.PI * 2);
                fCtx.fill();
                fCtx.globalAlpha = 1.0;

                // 5. Draw Header Branding
                fCtx.fillStyle = textColor;
                fCtx.font = '700 42px Outfit, sans-serif';
                fCtx.fillText('AI PORTFOLIO EXPERIMENT', 60, 100);

                fCtx.font = '400 22px Outfit, sans-serif';
                fCtx.fillStyle = dimColor;
                fCtx.fillText('Comparing 4 AI Models with $1,000 each', 60, 145);

                // 6. Composite the Chart
                fCtx.drawImage(exportChartCanvas, 40, 180, 1120, 520);

                // 7. Draw the Legend manually for perfect alignment
                const legendXStart = 60;
                const legendY = 720;
                let currentX = legendXStart;

                modelOrder.forEach(model => {
                    const label = modelVersions[model];
                    fCtx.fillStyle = colors[model];
                    fCtx.beginPath();
                    fCtx.arc(currentX, legendY - 6, 6, 0, Math.PI * 2);
                    fCtx.fill();

                    fCtx.fillStyle = dimColor;
                    fCtx.font = '600 16px Outfit, sans-serif';
                    fCtx.fillText(label, currentX + 15, legendY);

                    const textWidth = fCtx.measureText(label).width;
                    currentX += textWidth + 60;
                });

                // 8. Branding Footer
                fCtx.fillStyle = dimColor;
                fCtx.font = '600 16px Outfit, sans-serif';
                fCtx.textAlign = 'right';
                fCtx.fillText('aiportfolioexperiment.substack.com', 1140, 760);

                // 9. Share or Download
                const filename = `AI-Portfolio-Snapshot-${new Date().toISOString().split('T')[0]}.png`;

                finalCanvas.toBlob(async (blob) => {
                    if (!blob) {
                        console.error('Failed to create blob');
                        snapshotChart.destroy();
                        return;
                    }

                    const file = new File([blob], filename, { type: 'image/png' });

                    // Check if truly on mobile device AND supports Web Share with files
                    const isMobileDevice = /Android|iPhone|iPad|iPod|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    const canShareFiles = navigator.canShare && navigator.canShare({ files: [file] });

                    if (isMobileDevice && canShareFiles) {
                        try {
                            await navigator.share({
                                files: [file],
                                title: 'AI Portfolio Experiment',
                                text: 'Check out the AI Portfolio Experiment standings!'
                            });
                        } catch (err) {
                            // User cancelled or error - always fall back to download
                            console.log('Share cancelled or failed, falling back to download:', err);
                            triggerDownload(blob, filename);
                        }
                    } else {
                        // Desktop or non-sharing device: Use traditional download
                        triggerDownload(blob, filename);
                    }

                    // Cleanup
                    snapshotChart.destroy();
                }, 'image/png', 1.0);
            }, 100);
        }

        function triggerDownload(blob, filename) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = filename;
            link.href = url;
            link.click();
            // Delay revocation to give browser time to start download
            setTimeout(() => URL.revokeObjectURL(url), 1000);
        }

        // Twitter share function
        function shareOnTwitter() {
            const experimentStart = new Date('2026-01-05');
            const today = new Date();
            const dayNumber = Math.ceil((today - experimentStart) / (1000 * 60 * 60 * 24));

            // Get rankings data
            const rankings = window.allRankings || [
                { name: 'ChatGPT', change: '0' },
                { name: 'Gemini', change: '0' },
                { name: 'Claude', change: '0' },
                { name: 'Perplexity', change: '0' }
            ];

            // Format each ranking with medal emojis
            const medals = ['', '', '', '4'];
            const leaderboard = rankings.map((item, idx) => {
                const sign = parseFloat(item.change) >= 0 ? '+' : '';
                return `${medals[idx]} ${item.name}: ${sign}${item.change}%`;
            }).join('\n');

            const tweetText = ` AI Stock Battle  Day ${dayNumber}

${leaderboard}

Which AI will win? Follow the live experiment 

https://seve1995.github.io/ai-portfolio-experiment/`;

            const tweetUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(tweetText)}`;
            window.open(tweetUrl, '_blank', 'width=550,height=480');
        }

        // Countdown timer
        function updateCountdown() {
            const experimentEnd = new Date('2026-03-31'); // March 31st, 2026
            const now = new Date();
            const diffMs = experimentEnd - now;
            const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));

            const countdownEl = document.getElementById('countdownValue');
            if (diffDays > 0) {
                countdownEl.textContent = `${diffDays} day${diffDays !== 1 ? 's' : ''}`;
            } else {
                document.getElementById('countdownBanner').innerHTML = '<span class="countdown-value">Experiment Complete</span>  See final results below';
            }
        }

        // Initialize countdown on load
        document.addEventListener('DOMContentLoaded', updateCountdown);



        // Portfolio Holdings
        let portfolioData = {};
        const holdingsDateSelect = document.getElementById('holdingsDateSelect');
        const holdingsGrid = document.getElementById('holdingsGrid');
        const modelOrder = ['ChatGPT', 'Gemini', 'Claude', 'Perplexity'];

        function loadPortfolios() {
            fetch('logs/portfolios.json')
                .then(response => {
                    if (!response.ok) throw new Error('Portfolio data not found');
                    return response.json();
                })
                .then(data => {
                    portfolioData = data;
                    populateDateSelector();
                })
                .catch(err => {
                    console.log('Portfolio fetch failed:', err);
                    holdingsGrid.innerHTML = '<p class="empty-holdings">No portfolio data available yet. Run log_portfolios.py to generate data.</p>';
                });
        }

        function populateDateSelector() {
            const dates = Object.keys(portfolioData).sort().reverse();
            holdingsDateSelect.innerHTML = '';

            if (dates.length === 0) {
                holdingsDateSelect.innerHTML = '<option value="">No data</option>';
                return;
            }

            dates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = date;
                holdingsDateSelect.appendChild(option);
            });

            // Show the latest date by default
            renderHoldings(dates[0]);
            // renderDonutCharts(dates[0]); // REMOVED
        }

        holdingsDateSelect.addEventListener('change', function () {
            renderHoldings(this.value);
        });

        function renderHoldings(date) {
            if (!portfolioData[date]) {
                holdingsGrid.innerHTML = '<p class="empty-holdings">No data for this date.</p>';
                return;
            }

            const dayData = portfolioData[date];
            holdingsGrid.innerHTML = '';

            modelOrder.forEach(model => {
                const modelData = dayData[model];

                // Handle both old (list) and new (dict) data structures
                let holdings = [];
                let cash = 0, equity = 0;

                if (Array.isArray(modelData)) {
                    // Old format (backup)
                    holdings = modelData;
                    const stockVal = holdings.reduce((sum, h) => sum + h.market_value, 0);
                    totalValue = 1000; // Assume baseline for old data
                    investedValue = stockVal;
                    cashValue = 1000 - stockVal;
                } else {
                    // New format (Alpaca Data)
                    holdings = modelData.positions || [];
                    totalValue = parseFloat(modelData.equity || 0);
                    cashValue = parseFloat(modelData.cash || 0);
                    investedValue = totalValue - cashValue;

                    // Sanity check: if invested < 0 (due to margin/settlement timing), clamp to 0
                    if (investedValue < 0) investedValue = 0;
                }

                const investedPct = totalValue > 0 ? (investedValue / totalValue) * 100 : 0;
                // const cashPct = totalValue > 0 ? (cashValue / totalValue) * 100 : 0; // Unused for bar width if we just use background

                const card = document.createElement('div');
                card.className = 'holdings-card';

                // Build sector-colored bar segments
                const sectorColors = {
                    'healthcare': '#10b981',
                    'technology': '#3b82f6',
                    'energy': '#f59e0b',
                    'consumer': '#ec4899',
                    'financial': '#8b5cf6',
                    'industrials': '#6366f1',
                    'materials': '#14b8a6',
                    'utilities': '#84cc16',
                    'real': '#f97316',       // Real Estate
                    'communication': '#06b6d4',
                    'unknown': '#6b7280'
                };

                let barSegmentsHtml = '';
                holdings.forEach(h => {
                    const holdingPct = totalValue > 0 ? (h.market_value / totalValue) * 100 : 0;
                    const sectorKey = (h.sector || 'unknown').toLowerCase().split(' ')[0];
                    const segmentColor = sectorColors[sectorKey] || sectorColors['unknown'];
                    // Enhanced tooltip with value
                    barSegmentsHtml += `<div class="bar-segment" style="width: ${holdingPct}%; background-color: ${segmentColor};" title="${h.ticker}  $${h.market_value.toFixed(0)}  ${h.sector || 'Unknown'}"></div>`;
                });

                // Add cash segment (empty track with tooltip)
                const cashPct = 100 - investedPct;

                card.innerHTML = `
                    <div class="holdings-card-header">
                        <h3>${model}</h3>
                    </div>
                    <div class="holdings-card-body">
                        <!-- Sector-Colored Allocation Bar -->
                        <div class="allocation-display">
                            <div class="allocation-bar-track" title="Cash: $${cashValue.toFixed(2)}">
                                ${barSegmentsHtml}
                            </div>
                            <div class="allocation-summary">
                                ${holdings.length} holding${holdings.length !== 1 ? 's' : ''}  ${investedPct.toFixed(0)}% invested  $${cashValue.toFixed(0)} cash
                            </div>
                        </div>
                        
                        ${renderHoldingsList(holdings, totalValue, sectorColors)}
                    </div>
                `;

                holdingsGrid.appendChild(card);
            });
        }

        function renderHoldingsList(holdings, totalValue, sectorColors) {
            if (holdings.length === 0) {
                return `<p class="empty-holdings">All Cash Strategy</p>`;
            }

            let html = '';
            holdings.forEach(h => {
                const plClass = h.unrealized_pl_pct >= 0 ? 'positive' : 'negative';
                const plSign = h.unrealized_pl_pct >= 0 ? '+' : '';

                // Sector Dot with color from sectorColors map
                let sectorDot = '';
                if (h.sector && h.sector !== 'Unknown') {
                    const sectorKey = h.sector.toLowerCase().split(' ')[0];
                    const dotColor = sectorColors[sectorKey] || sectorColors['unknown'] || '#6b7280';
                    sectorDot = `<span class="sector-dot" style="background-color: ${dotColor};" title="${h.sector}"></span>`;
                }

                html += `
                    <div class="holding-row">
                        <div class="h-col-ticker">
                            <span class="holding-ticker">${h.ticker}</span>
                            ${sectorDot}
                        </div>
                        <div class="h-col-stats">
                            <div class="stats-primary">
                                <span class="stats-value">$${h.market_value.toFixed(2)}</span>
                                <span class="stats-pnl ${plClass}">${plSign}${h.unrealized_pl_pct.toFixed(1)}%</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            return html;
        }

        // Activity Feed Logic
        const activityFeed = document.getElementById('activityFeed');
        function loadTransactions() {
            fetch('logs/transactions.json')
                .then(res => {
                    if (!res.ok) throw new Error('Transactions not found');
                    return res.json();
                })
                .then(data => {
                    renderActivityFeed(data);
                })
                .catch(err => {
                    console.log(err);
                    activityFeed.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-dim);">No recent activity found.</div>';
                });
        }

        function renderActivityFeed(transactions) {
            // Flatten and sort transactions by timestamp (newest first)
            let allTxs = [];
            Object.keys(transactions).forEach(model => {
                transactions[model].forEach(tx => {
                    allTxs.push({ ...tx, model });
                });
            });

            allTxs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // Limit to recent 20
            allTxs = allTxs.slice(0, 20);

            if (allTxs.length === 0) {
                activityFeed.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-dim);">No transactions yet.</div>';
                return;
            }

            activityFeed.innerHTML = '';

            allTxs.forEach(tx => {
                const isBuy = tx.side === 'buy';
                const timeStr = new Date(tx.timestamp).toLocaleString();

                const item = document.createElement('div');
                item.className = 'activity-item';

                const iconSvg = isBuy
                    ? `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>`
                    : `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>`;

                item.innerHTML = `
                    <div class="activity-icon ${isBuy ? 'buy' : 'sell'}">
                        ${iconSvg}
                    </div>
                    <div class="activity-content">
                        <strong>${tx.model}</strong> ${tx.side === 'buy' ? 'bought' : 'sold'} 
                        <strong>${tx.qty} ${tx.symbol}</strong> at $${tx.price.toFixed(2)}
                    </div>
                    <div class="activity-time">
                        ${timeAgo(new Date(tx.timestamp))}
                    </div>
                `;
                activityFeed.appendChild(item);
            });
        }

        // Helper for time ago
        function timeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "y ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "m ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "d ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "h ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "m ago";
            return "Just now";
        }

        // Global Donut Chart Instances to manage updates
        const donutInstances = {};

        function renderDonutCharts(date) {
            if (!portfolioData[date]) return;
            const dayData = portfolioData[date];

            modelOrder.forEach(model => {
                const canvasId = `donut-${model}`;
                const canvas = document.getElementById(canvasId);
                if (!canvas) return;

                const modelData = dayData[model];
                let holdings = Array.isArray(modelData) ? modelData : (modelData.positions || []);
                const cashValue = Array.isArray(modelData) ? (1000 - holdings.reduce((s, h) => s + h.market_value, 0)) : parseFloat(modelData.cash || 0);

                // Aggregate by Sector
                const sectorMap = { 'Cash': cashValue };
                holdings.forEach(h => {
                    const sector = h.sector && h.sector !== 'Unknown' ? h.sector.split(' ')[0] : 'Other'; // Simplified sector key
                    if (!sectorMap[sector]) sectorMap[sector] = 0;
                    sectorMap[sector] += h.market_value;
                });

                // Prepare Data
                const labels = Object.keys(sectorMap);
                const dataValues = Object.values(sectorMap);

                // Colors
                const sectorColors = {
                    'Healthcare': '#10b981', 'Technology': '#3b82f6', 'Energy': '#f59e0b',
                    'Consumer': '#ec4899', 'Financial': '#8b5cf6', 'Industrials': '#6366f1',
                    'Materials': '#14b8a6', 'Utilities': '#84cc16', 'Real': '#f97316',
                    'Communication': '#06b6d4', 'Other': '#6b7280', 'Cash': 'rgba(128,128,128,0.2)'
                };
                const bgColors = labels.map(l => {
                    // Match fuzzy keys (e.g. 'Tech' matches 'Technology')
                    const key = Object.keys(sectorColors).find(k => k.toLowerCase().startsWith(l.toLowerCase())) || 'Other';
                    // Specific case for Cash
                    if (l === 'Cash') return sectorColors['Cash'];
                    return sectorColors[key];
                });

                // Destroy existing chart if any
                if (donutInstances[model]) {
                    donutInstances[model].destroy();
                }

                // Render Chart
                donutInstances[model] = new Chart(canvas, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: dataValues,
                            backgroundColor: bgColors,
                            borderColor: 'transparent',
                            borderWidth: 0,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        cutout: '75%',
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                bodyColor: '#fff',
                                callbacks: {
                                    label: function (context) {
                                        const val = context.raw;
                                        const total = context.chart._metasets[context.datasetIndex].total;
                                        const pct = (val / total * 100).toFixed(1);
                                        return `${context.label}: ${pct}%`;
                                    }
                                }
                            }
                        },
                        animation: {
                            animateScale: true,
                            animateRotate: true
                        }
                    }
                });
            });
        }

        // Load portfolios and transactions on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadPortfolios();
            loadTransactions();
        });
    </script>
</body>

</html>